# Day 3 - Active Defense and Cyber Deception w/ John Strand

https://www.youtube.com/watch?v=KinF1-o9GLQ

## Summary

Day 3 of the Active Defense and Cyber Deception class focused on implementing various honeypot technologies and deception techniques. John demonstrated how to set up auto-dropping honeypots using bash scripting, create Port Spoof installations to confuse attackers' scanning tools, configure Cowrie honeypots to capture SSH attack attempts, and implement web honeypots that mimic Outlook Web Access portals. Throughout the session, John emphasized the practical implementation of these technologies, showing how they can significantly increase attack time while providing valuable intelligence about attackers' techniques and tools.

## Key Takeaways

1. **Scripting honeypots is accessible**: Even with basic bash scripting skills, security professionals can create effective honeypot solutions like the auto-drop script demonstrated in class. These solutions don't require expensive commercial tools, just understanding of fundamental network concepts.
2. **Port Spoof dramatically slows attackers**: By responding to port scans with misleading service information, Port Spoof can extend a simple 10-port scan from seconds to minutes, and a full port scan to over 65 hours, giving defenders valuable time to detect and respond.
3. **Honeypots should be customized**: Default installations of honeypots like Cowrie are easily detected by experienced attackers. Simple customizations like changing the hostname and banner messages make them much more effective.
4. **Attack noise provides detection opportunities**: Web honeypots demonstrate the significant volume of traffic generated by attackers, providing numerous opportunities for detection while also reducing storage costs if these attacks can be blocked early.

## Active Defense & Cyber Deception - Day 3 Study Notes

## Honey Port Auto-Drop Implementation

### Bash Scripting for Auto-Drop Honey Ports

- A bash script can be created to:
    - Listen on a specific port
    - Capture the IP address of connecting systems
    - Automatically block these IPs with iptables
- The script uses several key components:
    - `netcat`: To listen on a port and capture connections
    - `grep`: To filter specific connection data
    - `awk`: To extract the IP address from connection data
    - `iptables`: To block the extracted IP address

### Key Technical Insights

- The script only blocks connections that complete a full TCP handshake
- Scans that just send SYN packets (like default nmap scans) won't trigger the auto-block
- This makes the honey port resistant to IP spoofing attacks
- When a full connection is established, it indicates:
    - A real connection attempt (not scanning)
    - The IP address is legitimate (not spoofed)
- Preventing accidental blocks:
    - Add a rule above the blocking rules to allow legitimate scanners
    - Rules are evaluated from top to bottom

### Windows PowerShell Version

- Similar functionality can be achieved in Windows environments using PowerShell
- The Windows version uses different syntax but the same principles

## Port Spoof Implementation

### What is Port Spoof?

- A tool that responds to port scans with misleading service information
- Appears to have all ports open with random or misleading service banners
- Can dramatically slow down port scanning and enumeration

### How Port Spoof Works

1. Creates iptables rules to redirect traffic from specified ports to port 4444
2. Listens on port 4444 and responds to connection attempts
3. Provides false service banners/identifiers to scanners

### Effective Implementation

- Only needs to be installed on one system per subnet to be effective
- Works against multi-threaded scanners by creating a "sink" that consumes scanning resources
- Significantly increases scan time:
    - Scanning 10 ports: ~36 seconds
    - Extrapolated to all 65,536 ports: ~65 hours

### Psychological Impact

- Exploits the "sunk cost fallacy" in attackers
- Scanners don't provide real-time feedback about hang-ups
- Attackers don't know if they should abort a scan or wait for completion
- Creates indecision and wastes attacker time

## Cowrie SSH Honeypot

### What is Cowrie?

- Medium-interaction SSH and Telnet honeypot
- Captures login attempts and post-authentication activity
- Logs commands executed by attackers
- Can be run in Docker for easy deployment

### Customizing Cowrie

- Default installations are easily detected by experienced attackers
- Key customizations:
    - Hostname (default is "server04")
    - Message of the day banner
    - SSH key fingerprint (automatically changes with each restart)
    - User database

### Configuration File Location

- In Docker: `/var/lib/docker/overlay2/[long-hash]/etc/cowrie/cowrie.cfg`
- Contains many configuration options:
    - Hostname settings
    - Download directories
    - Filesystem emulation
    - Editor settings
    - Logging options

### Threat Intelligence Value

- Captures attacker tools, techniques, and procedures
- Provides actionable intelligence specific to your environment:
    - Command and control server IPs
    - Malware download locations
    - Filenames and execution paths
    - Attacker commands and patterns

## Web Honeypots

### OA (Outlook Web Access) Honeypot

- Mimics an Exchange server OWA portal
- Attractive target for attackers (on-premise Exchange servers are high-value)
- Captures login attempts and attack patterns

### Web Attack Detection

- Web attacks generate significant log volume
- Clear evidence of malicious activity (thousands of entries)
- Can be used to:
    - Generate alerts
    - Implement IP blocking
    - Gather threat intelligence

### Cost Benefits of Early Blocking

- Reducing log volume saves storage costs
- Improves signal-to-noise ratio in security monitoring
- Helps focus on sophisticated attacks rather than "ankle biters"
- Blocks script kiddies and automated scanners

## Other Honeypot Technologies

### Artillery

- Open-source honeypot and monitoring tool by TrustedSec
- Provides honeypot services and file monitoring
- Can alert on changes to critical files (like /etc/shadow)

### Web Labyrinth

- Advanced web honeypot with "random wheel of errors"
- Returns different HTTP error codes randomly
- Can use full text (like Alice in Wonderland) for link generation
- Can reflect known attack patterns to trigger IDS/IPS

### Conpot

- Industrial Control System (ICS)/SCADA honeypot
- Emulates Siemens PLCs and other industrial systems
- Needs customization to avoid detection

## Practical Implementation Considerations

### Denialist Approach

- After detection threshold, automatically block attacker IPs
- Benefits:
    - Reduces log storage costs
    - Improves signal-to-noise ratio
    - Preserves resources for detecting sophisticated attacks

### Cloud Deployment

- Honeypots can be deployed as Docker containers in cloud environments
- Similar implementation as on-premises, with different networking
- Same detection and alert mechanisms apply

### Low-Interaction vs. High-Interaction

- Focus on low-interaction, high-fidelity honeypots
- Set-it-and-forget-it approach rather than complex sandboxes
- No need for a dedicated team to manage cyber deception

### Customizing Default Services

- Change default banners, hostnames, and configurations
- Avoid using default installations that are easily fingerprinted
- Make honeypots blend in with your legitimate environment

## Quiz Questions

1. **Question**: In John Strand's approach to honeypots, what makes the TCP auto-drop script resistant to IP spoofing attacks?
    - **Answer**: The script only blocks IPs that complete a full TCP three-way handshake, which is nearly impossible to spoof. The script waits for a connection with the "received" state, meaning a full connection was established, not just a SYN packet.
2. **Question**: According to the Port Spoof lab, approximately how long would it take to scan all 65,536 ports on a system running Port Spoof if scanning 10 ports took 36 seconds?
    - **Answer**: Approximately 65 hours. The calculation shows that if 10 ports took 36 seconds, then scanning all 65,536 ports would take around 65 hours, which dramatically increases the attack time and creates opportunities for detection.
3. **Question**: What are two key customizations that should be made to a Cowrie SSH honeypot to make it less detectable to attackers?
    - **Answer**: The hostname should be changed from the default "server04" and the Message of the Day (MOTD) banner should be customized. Additionally, Cowrie automatically changes the SSH key fingerprint with each restart, which also helps avoid detection.
4. **Question**: How can web honeypots potentially save an organization money, according to the example John shared about Apple's security team?
    - **Answer**: Web honeypots can identify attackers early, allowing organizations to deny-list them, which reduces the volume of attack logs that need to be stored and processed in cloud environments. This saves on storage costs and data transfer fees while improving the signal-to-noise ratio for security monitoring.

## Noteworthy Quotes

> "This simple change in the way that you think about computer security makes all the difference in the world. My point is yes, you may feel like you're at a disadvantage as a defender, but the goal of this class is to change that around."
> 

> "Your tears make the best wine." (In reference to pen testers complaining about encountering Port Spoof during assessments)
> 

> "Getting compromised is acceptable. I know that sounds weird, I know that sounds crazy, but it's acceptable in the fact that it's like death and taxes... What is not acceptable is for an attacker to persist for months."
> 

> "It only fires when someone establishes a full TCP IP handshake... You can't spoof a fully established TCP IP connection."
> 

> "If you work with a standard spider trap instance, and that spider trap instance is constantly sending the same responses again and again and again, there are automated crawlers out there that'll learn that that is probably a honeypot trap."
> 

> "If you're spending a whole bunch of time, effort, and money standing up and running your deception, you're doing it wrong. Most of your deception should be the set it and forget it, Ron Popeil style, cyber deception, low interaction, high fidelity."
> 

> "Detection time plus reaction time must be less than the amount of time it takes for an attacker to successfully try to break into an environment... We have now greatly increased the attack time and the attacker, within their OODA loop, we've blinded them."
>
